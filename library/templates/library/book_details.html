{% extends 'base.html' %}
{% load staticfiles %}

{% block breadcrumb %}
    {{ block.super }}                 
    <li class="breadcrumb-item active">{{ book.title }}</li>
{% endblock breadcrumb %}
{% block breadcrumbinfo %}Knygos aprašymas{% endblock breadcrumbinfo %}

{% block content %}
<div class="row">
    <div class="col-sm-8">
        <div class="row">
            <div class="col-sm-12 col-md-4 pr-0">
                {% if book.cover %}
                    <img class="img-fluid" src="{{ book.cover.url }}">
                {% else %}
                    <img class="img-fluid" src="{% static 'img/no_cover.jpg' %}">
                {% endif %}
            </div><!--/book image column-->
            <div class="col-sm-12 col-md-8">
                    <div class="float-right">
                        {% if book in user.info.bookmarks.all %}
                            <h1><i class="fa fa-star bookmarked" role="button" id="bookmark" data-toggle='popover' data-trigger='hover' data-content='Pamiršti' data-placement='top'></i></h1>
                        {% else %}
                            <h1><i class="fa fa-star bookmark" role="button" id="bookmark" data-toggle='popover' data-trigger='hover' data-content='Prisiminti' data-placement='top'></i></h1>
                        {% endif %}
                    </div>
            
                <h4>knygos info</h4>
            </div><!--/book info column-->

            <div class="col-sm-12 pt-2">
                <ul class="nav nav-pills mb-3 nav-justified" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-comments" role="tab" aria-controls="pills-home" aria-selected="true">Komentarai  <i class="far fa-comments"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-reviews" role="tab" aria-controls="pills-profile" aria-selected="false">Apžvalgos <i class="fas fa-balance-scale"></i></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="pills-contact-tab" data-toggle="pill" href="#pills-tags" role="tab" aria-controls="pills-contact" aria-selected="false">Tagai <i class="fab fa-slack-hash"></i></a>
                    </li>
                    </ul>
                <div class="tab-content" id="pills-tabContent">
                    <!-- Komentarai -->
                    <div class="tab-pane fade show active" id="pills-comments" role="tabpanel" aria-labelledby="pills-home-tab">
                        <div class="comments-container">    
                                <ul id="comments-list" class="comments-list">
                                    <li>
                                        <div class="comment-main-level">
                                            <!-- Avataras -->
                                            <div class="comment-avatar"><img src="{% static 'img/profile_icon.jpg' %}" alt=""></div>
                                            <!-- komentaras -->
                                            <div class="comment-box" comId="1">
                                                <div class="comment-head">
                                                    <h6 class="comment-name by-author"><a href="#">GėlinisSkaitytojas</a></h6>
                                                    <span>prieš 2 dienas</span>
                                                    <i class="fa fa-reply" data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i>
                                                </div>
                                                <div class="comment-content">
                                                    Pati mylmiausia knyga šioje žemėje!!! &#x1F60D;&#x1F60D;
                                                </div>
                                            </div>
                                        </div>
                                        <!-- komentarai atsakymai -->
                                        <ul class="comments-list reply-list">
                                            <li>
                                                <!-- Avataras -->
                                                <div class="comment-avatar"><img src="{% static 'img/profile_icon2.png' %}" alt=""></div>
                                                <!-- komentaras -->
                                                <div class="comment-box" comId="2">
                                                    <div class="comment-head">
                                                        <h6 class="comment-name"><a href="#">Žuvėdra68</a></h6>
                                                        <span>prieš 20 minučių</span>
                                                        <i class="fa fa-reply" data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i>
                                                    </div>
                                                    <div class="comment-content">
                                                        Ilgas tekstas apie tai, jog yra daug įdomesnių knygų...
                                                    </div>
                                                </div>
                                            </li>
                        
                                            <li>
                                                <!-- Avataras -->
                                                <div class="comment-avatar"><img src="{% static 'img/profile_icon.jpg' %}" alt=""></div>
                                                <!-- komentaras -->
                                                <div class="comment-box" comId="3">
                                                    <div class="comment-head">
                                                        <h6 class="comment-name by-author"><a href="http://creaticode.com/blog">GėlinisSkaitytojas</a></h6>
                                                        <span>prieš 11 minučių</span>
                                                        <i class="fa fa-reply" data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i>
                                                    </div>
                                                    <div class="comment-content">
                                                        Bet kiekvienas turi savo nuomonę ir mėgstamiausią knygą. &#x1F622;
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                        
                                    <li>
                                        <div class="comment-main-level">
                                            <!-- Avataras -->
                                            <div class="comment-avatar"><img src="{% static 'img/profile_icon2.png' %}" alt=""></div>
                                            <!-- komentaras -->
                                            <div class="comment-box" comId="4">
                                                <div class="comment-head">
                                                    <h6 class="comment-name"><a href="#">Žuvėdra68</a></h6>
                                                    <span>prieš 10 minučių</span>
                                                    <i class="fa fa-reply" data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i>
                                                </div>
                                                <div class="comment-content">
                                                    Sorry bet ne...
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <!-- komentaro rašymas-->
                            <div class="comments-container mt-0">
                                <h1 id="reply">Komentuok</h1>
                                <ul id="comments-list" class="comments-list">
                                    <li>
                                        <div class="comment-main-level">
                                            <!-- Avataras -->                                            
                                            <div class="comment-avatar">
                                                {% if user.info.avatar %}
                                                    <img src="{{ user.info.avatar.url }}" alt="">
                                                {% else %}
                                                    <img src="{% static 'img/profile_icon2.png' %}" alt="">
                                                {% endif %}
                                            </div>
                                            <!-- komentaras -->
                                            <div class="comment-box">
                                                <div class="comment-head">
                                                    <h6 class="comment-name"><a href="#">{{ user.username }}</a></h6>
                                                    <span>dabar</span>
                                                </div>
                                                <div class="comment-content">
                                                    <form class="clearfix" id="newCommentForm" method="POST" action="{% url 'library:comment' book.slug %}">{% csrf_token %}
                                                        <input type="hidden" name="isReply" value="0">
                                                        <div class="form-group" id="newcomment">
                                                            <textarea class="form-control" id="newcomment_text" rows="3" placeholder="Prašau be spoilerių" name="newcoment_text" maxlength="200"></textarea>
                                                            <div class="invalid-feedback">Negali būti tuščias</div>
                                                        </div>
                                                        <button type="submit" class="btn btn-dark float-right"><i class="fas fa-comment"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div><!--/comments container-->

                    </div><!--/comments tab-->
                    <div class="tab-pane fade" id="pills-reviews" role="tabpanel" aria-labelledby="pills-profile-tab">
                        <div class="row align-items-center">
                            <div class="col-sm-12 text-center py-5">
                                <h1 class="text-muted py-5">Comming soon... 2022</h1>
                            </div>                                
                        </div>
                    </div>
                    <div class="tab-pane fade" id="pills-tags" role="tabpanel" aria-labelledby="pills-contact-tab">
                        <div class="row align-items-center">
                            <div class="col-sm-12 text-center py-5">
                                <h1 class="text-muted py-5">Comming soon... 2021</h1>
                            </div>                                
                        </div>
                    </div>
                </div>
            </div><!--/book tabs column-->

        </div><!--/first row on the left-->
    </div><!--/left column-->

    <div class="col-sm-4">
        <h4>kalbos ir prid4ti knyga</h4>
    </div><!--/right column-->


</div><!--/whole page-->
{% endblock content %}



{% block javascript %}
{{ block.super }}
<script>
    $( document ).ready(function() {
        $('[data-toggle="popover"]').popover(); 
        bookmark()
        addComment()
        reply()
    
        function reply(){
            $(".fa-reply").click(function(e) {
                //get parent div
                let parentComment = $(this).closest(".comment-box")
    
                changeReplyText(parentComment)
                $('[data-toggle="popover"]').popover(); 
                //move to reply area and focus it boiiiii
                $('html, body').animate({
                    scrollTop: $("#reply").offset().top - 200
                }, 1000);            
                $("#newcomment_text").focus();
    
                $("#dontreply").click(function(e) {
                    console.log("bandysim pasalinti reply")
                    $(this).closest("div").fadeOut(300, function() { $(this).closest("div").remove(); });
                    $('.popover').popover('hide');
                    //$(this).closest("div").remove()
                    changeIsReply(0)
                });                
    
            });
        }
    
        function changeReplyText(parentComment){
            //get coment author
            let author = parentComment.find(".comment-name")
            author = author.text()
            console.log(author)
    
            //get comment id
            let id = parentComment.attr("comId")
            console.log(id)
            changeIsReply(id)
    
            //get comment text
            let comment = parentComment.find(".comment-content")
            comment = comment.text().trim()
            console.log(comment)
    
            let replyText = $("#newcomment")
            replyText.find("div#replyingTo").remove()
            replyText.prepend("<div id='replyingTo'><button id='dontreply' type='button' class='close' aria-label='Close' data-toggle='popover' data-trigger='hover' data-content='Atšaukti' data-placement='top'><span aria-hidden='true'>&times;</span></button><h5>Atsakai į " + author + " komentarą:</h5><p>" + comment + "</p></div>")
        }
    
        function changeIsReply(id){
            let isReply = $("input[name='isReply']")
            isReply.val(id)
        }
    
        function bookmark(){
            $("#bookmark").click(function(e) {
                console.log("bandysim bookmarkint")
                let btn = $(this)
                $.ajax({
                    url: "{% url 'library:bookmark' book.slug %}",
                    /*
                    data: {
                        text: $("textarea[name=Status]").val(),
                        Status: 'test'
                    },
                    dataType : 'json',*/
                    success: function(data){
                        console.log(data)
                        console.log(btn.attr('class'))
                        btn.toggleClass('bookmark')
                        btn.toggleClass('bookmarked')
                        if(btn.attr('data-content') == 'Prisiminti'){
                            btn.attr('data-content', 'Pamiršti')
                        } else {
                            btn.attr('data-content', 'Prisiminti')
                        }          
                    },
                    error: function(data){
                        console.log('nepaejo')
                    }
                });
            });
        }
    
        function addComment(){
            let form = $("#newCommentForm")
    
            form.submit(function(e){
                e.preventDefault()
                let csrf_token = form.find("[name='csrfmiddlewaretoken']").val()
                let text = form.find("textarea").val().trim()              
                let parentId = form.find("[name='isReply']").val()
                console.log("CSRF: " + csrf_token + "\nTEXT: " + text + "\nPARENDID: " + parentId)
                $.ajax({
                    type: 'POST',
                    url: form.attr("action"),
                    data:{
                        'csrfmiddlewaretoken': csrf_token,
                        'text': text,
                        'parentId': parentId,
                    },
                    success: function(data){
                        let textarea = form.find("textarea")
                        if(data.error){
                            console.log(data.error)
                            form.find("textarea").addClass("is-invalid")
                        } else if(parentId == 0){                            
                            textarea.removeClass("is-invalid")
                            textarea.val('')
                            let commentDiv = $("#comments-list:first")
                            text = text.replace(/(?:\r\n|\r|\n)/g, '<br>');
                            commentDiv.append("<li><div class='comment-main-level'><div class='comment-avatar'><img src='{{ user.info.avatar.url }}' alt=''></div><div class='comment-box' comId='4'><div class='comment-head'><h6 class='comment-name'><a href='#'>{{ user.username }}</a></h6><span>dabar</span><i class='fa fa-reply' data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i></div><div class='comment-content'>" + text + "</div></div></div></li>")
                            $('html, body').animate({
                                scrollTop: commentDiv.find("li").last().offset().top - 800
                            }, 1000);                                                     
                        } else {
                            textarea.removeClass("is-invalid")
                            textarea.val('')
                            let parentCom = $("[comId='"+ parentId +"'")
                            parentCom = parentCom.closest(".reply-list")
                            parentCom.append("<li><div class='comment-main-level'><div class='comment-avatar'><img src='{{ user.info.avatar.url }}' alt=''></div><div class='comment-box' comId='4'><div class='comment-head'><h6 class='comment-name'><a href='#'>{{ user.username }}</a></h6><span>dabar</span><i class='fa fa-reply' data-toggle='popover' data-trigger='hover' data-content='Atsakyti' data-placement='top'></i></div><div class='comment-content'>" + text + "</div></div></div></li>")
                            $('html, body').animate({
                                scrollTop: parentCom.find("li").last().offset().top - 500
                            }, 1000);
                            let replyText = $("#newcomment")
                            replyText.find("div#replyingTo").remove()
    
                        }
                        reply()
                    }                    
                })
    
    
            })
        }
    
    });
</script>
{% endblock javascript %}